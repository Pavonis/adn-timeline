/*!
App.net timeline fetcher (c) 2013 Brandon Mathis - @imathis // MIT License
*/
(function(){var e=[].slice;window.AdnTimeline={defaults:{el:".adn-timeline",count:4,replies:!1,reposts:!1,cookie:"adn-timeline"},init:function(e){var t,n,r,i=this;e==null&&(e=[{}]),e instanceof Array||(e=[e]);for(n=0,r=e.length;n<r;n++)t=e[n],$(t.el||this.defaults.el).each(function(e,n){var r,s,o;return n=$(n),o=i.cascadeOptions(n.attr("data-username"),t.username),o==null?console.error("You need to provide an App.net username"):(s=t.render||i.render,r=t.callback||function(){},i.timeline(i.helpers).fetch(s,r,{el:n,user:o,count:i.cascadeOptions(parseInt(n.attr("data-count")),t.count,i.defaults.count),replies:i.cascadeOptions(i.parseBool(n.attr("data-replies")),t.replies,i.defaults.replies),reposts:i.cascadeOptions(i.parseBool(n.attr("data-reposts")),t.reposts,i.defaults.reposts),cookie:i.cascadeOptions(i.parseBool(n.attr("data-cookie")),t.cookie)},""+i.defaults.cookie+"-"+o))});return this},cascadeOptions:function(){var t,n,r,i;n=1<=arguments.length?e.call(arguments,0):[];for(r=0,i=n.length;r<i;r++){t=n[r];if(t!=null&&t===t)return t}},parseBool:function(e){if(e!=null)return e=e.trim(),e.match(/^true$/i)?!0:e.match(/^false/i)?!1:console.error('"'+e+'" cannot be parsed as Boolean')},render:function(e,t){var n,r,i,s;r="<ul>";for(i=0,s=t.length;i<s;i++)n=t[i],r+="<li><figure class='post'>",r+="<blockquote><p>",r+=n.text,r+="</p></blockquote>",r+="<figcaption>",r+="<a href='"+n.url+"'><time datetime='"+n.date+"'>"+n.display_date+"</time></a>",r+="</figcaption>",r+="</figure></li>";return r+="</ul>",e.append(r)},timeline:function(e){return{data:[],fetch:function(t,n,r){var i,s,o,u=this;return $.cookie&&r.cookie&&(s=$.cookie(r.cookie))?(i=JSON.parse(s),i.length!==r.count?($.removeCookie(r.cookie),this.fetch(t,n,r)):(t(r.el,i),n(i))):(o="https://alpha-api.app.net/stream/0/users/@"+r.user+"/posts?include_deleted=0",r.before_id&&(o+="&before_id="+r.before_id),r.replies||(o+="&include_directed_posts=0"),o+="&callback=?",$.ajax({url:o,dataType:"jsonp",error:function(e){return console.error("Error fetching App.net timeline"),console.error(e)},success:function(s){var o,a,f,l;if(!r.reposts){i=[],l=s.data;for(a=0,f=l.length;a<f;a++)o=l[a],o.repost_of||i.push(o);s.data=i}return u.data=u.data.concat(s.data),u.data.length<r.count?(r.before_id=s.meta.min_id,u.fetch(t,n,r)):(u.data=function(){var t,n,i,s;i=this.data.slice(0,r.count),s=[];for(t=0,n=i.length;t<n;t++)o=i[t],s.push(e.postData(o));return s}.call(u),$.cookie&&r.cookie&&$.cookie(r.cookie,JSON.stringify(u.data,{path:"/"})),t(r.el,u.data),n(u.data))}}))}}},helpers:{trimUrl:function(e){var t,n,r,i,s,o,u;r=[],t=40,e=e.replace(/(https?:\/\/)/i,""),u=e.split("/");for(s=0,o=u.length;s<o;s++){n=u[s];if(!(r.concat(n).join("/").length<t))break;r.push(n)}return i=r.join("/"),e.length-i.length>15&&(i=e.slice(0,t)),i.length<e.length?i+"&hellip;":i},trimDisplayUrls:function(e){var t=this;return e.replace(/>\s*(https?:\/\/.+?)\s*</gi,function(e,n){return">"+t.trimUrl(n)+"<"})},linkify:function(e){var t,n,r,i,s,o,u,a,f;r=this.trimDisplayUrls(e.html),a=e.entities.mentions;for(i=0,o=a.length;i<o;i++)n=a[i],r=r.replace(new RegExp("@("+n.name+")","gi"),"<a href='https://alpha.app.net/$1'>@$1</a>");f=e.entities.hashtags;for(s=0,u=f.length;s<u;s++)t=f[s],r=r.replace("#"+t.name,"<a href='https://alpha.app.net/hashtags/"+t.name+"'>#"+t.name+"</a>");return r},postData:function(e){return{url:e.canonical_url,date:e.created_at,display_date:this.timeago(e.created_at),author:{username:e.user.username,name:e.user.name,url:e.user.canonical_url},text:this.linkify(e)}},timeago:function(e){var t,n,r,i,s,o;return i={just_now:"now",minute_ago:"1m",minutes_ago:"m",hour_ago:"1h",hours_ago:"h",yesterday:"1d",days_ago:"d",last_week:"1w",weeks_ago:"w"},s=((new Date).getTime()-(new Date(e)).getTime())/1e3,r=Math.floor(s/60),n=Math.floor(s/3600),t=Math.floor(s/86400),o=Math.floor(t/7),isNaN(s)||t<0?"#":t===0?s<60?i.just_now:s<120?i.minute_ago:s<3600?r+i.minutes_ago:s<7200?i.hour_ago:n+i.hours_ago:t===1?i.yesterday:t<7?t+i.days_ago:t===7?i.last_week:o+i.weeks_ago}}}}).call(this);